







WITH staging AS (
-- Generated by dbtvault.

    

WITH source_data AS (

    SELECT

    `ORDER_ID`,
    `ORDER_NUMBER`,
    `ORDER_PRICE`,
    `CUSTOMER_ID`,
    `LASTMODIFIEDDATE`,
    `CREATEDDATE`,
    `CRUD_FLAG`,
    `CUSTOMER_NUMBER`

    FROM `steadfast-task-363413`.`data_vault`.`v_raw_order`
),

derived_columns AS (

    SELECT

    `ORDER_ID`,
    `ORDER_NUMBER`,
    `ORDER_PRICE`,
    `CUSTOMER_ID`,
    `LASTMODIFIEDDATE`,
    `CREATEDDATE`,
    `CRUD_FLAG`,
    `CUSTOMER_NUMBER`,
    ORDER_NUMBER AS `ORDER_KEY`,
    CUSTOMER_NUMBER AS `UK_CUSTOMER_KEY`,
    '2' AS `RECORD_SOURCE`,
    LASTMODIFIEDDATE AS `EFFECTIVE_FROM`

    FROM source_data
),

hashed_columns AS (

    SELECT

    `ORDER_ID`,
    `ORDER_NUMBER`,
    `ORDER_PRICE`,
    `CUSTOMER_ID`,
    `LASTMODIFIEDDATE`,
    `CREATEDDATE`,
    `CRUD_FLAG`,
    `CUSTOMER_NUMBER`,
    `ORDER_KEY`,
    `UK_CUSTOMER_KEY`,
    `RECORD_SOURCE`,
    `EFFECTIVE_FROM`,

    CAST(UPPER(TO_HEX(SHA256(NULLIF(UPPER(TRIM(CAST(`ORDER_KEY` AS STRING))), '')))) AS STRING) AS `ORDER_HK`,
    CAST(UPPER(TO_HEX(SHA256(NULLIF(UPPER(TRIM(CAST(`UK_CUSTOMER_KEY` AS STRING))), '')))) AS STRING) AS `CUSTOMER_HK`,
    UPPER(TO_HEX(SHA256(NULLIF(CONCAT(
        IFNULL(NULLIF(UPPER(TRIM(CAST(`ORDER_KEY` AS STRING))), ''), '^^'),'||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(`UK_CUSTOMER_KEY` AS STRING))), ''), '^^')
    ), '^^||^^')))) AS `CUSTOMER_ORDER_HK`,
    UPPER(TO_HEX(SHA256(CONCAT(
        IFNULL(NULLIF(UPPER(TRIM(CAST(`CREATEDDATE` AS STRING))), ''), '^^'),'||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(`CRUD_FLAG` AS STRING))), ''), '^^'),'||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(`CUSTOMER_ID` AS STRING))), ''), '^^'),'||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(`LASTMODIFIEDDATE` AS STRING))), ''), '^^'),'||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(`ORDER_ID` AS STRING))), ''), '^^'),'||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(`ORDER_NUMBER` AS STRING))), ''), '^^'),'||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(`ORDER_PRICE` AS STRING))), ''), '^^')
    )))) AS `ORDER_HASHDIFF`

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    `ORDER_ID`,
    `ORDER_NUMBER`,
    `ORDER_PRICE`,
    `CUSTOMER_ID`,
    `LASTMODIFIEDDATE`,
    `CREATEDDATE`,
    `CRUD_FLAG`,
    `CUSTOMER_NUMBER`,
    `ORDER_KEY`,
    `UK_CUSTOMER_KEY`,
    `RECORD_SOURCE`,
    `EFFECTIVE_FROM`,
    `ORDER_HK`,
    `CUSTOMER_HK`,
    `CUSTOMER_ORDER_HK`,
    `ORDER_HASHDIFF`

    FROM hashed_columns
)

SELECT * FROM columns_to_select
)

SELECT *,
       '2009-11-05 08:36.000000' AS LOAD_DATE
FROM staging