
        
    

    

    merge into `steadfast-task-363413`.`data_vault`.`sat_customer_wealth_bracket` as DBT_INTERNAL_DEST
        using (
          -- Generated by dbtvault.

    

WITH source_data AS (
    SELECT a.`CUSTOMER_WEALTH_BRACKET_HK`, a.`CUSTOMER_WEALTH_BRACKET_HASHDIFF`, a.`NAME`, a.`DESCRIPTION`, a.`LASTMODIFIEDDATE`, a.`CREATEDDATE`, a.`EFFECTIVE_FROM`, a.`LOAD_DATE`, a.`RECORD_SOURCE`
    FROM `steadfast-task-363413`.`data_vault`.`v_stg_customer_wealth_bracket` AS a
    WHERE a.`CUSTOMER_WEALTH_BRACKET_HK` IS NOT NULL
),



latest_records AS (
    SELECT a.`CUSTOMER_WEALTH_BRACKET_HK`, a.`CUSTOMER_WEALTH_BRACKET_HASHDIFF`, a.`LOAD_DATE`
    FROM (
        SELECT current_records.`CUSTOMER_WEALTH_BRACKET_HK`, current_records.`CUSTOMER_WEALTH_BRACKET_HASHDIFF`, current_records.`LOAD_DATE`,
            RANK() OVER (
               PARTITION BY current_records.`CUSTOMER_WEALTH_BRACKET_HK`
               ORDER BY current_records.`LOAD_DATE` DESC
            ) AS rank
        FROM `steadfast-task-363413`.`data_vault`.`sat_customer_wealth_bracket` AS current_records
            JOIN (
                SELECT DISTINCT source_data.`CUSTOMER_WEALTH_BRACKET_HK`
                FROM source_data
            ) AS source_records
                ON current_records.`CUSTOMER_WEALTH_BRACKET_HK` = source_records.`CUSTOMER_WEALTH_BRACKET_HK`
    ) AS a
    WHERE a.rank = 1
),records_to_insert AS (
    SELECT DISTINCT stage.`CUSTOMER_WEALTH_BRACKET_HK`, stage.`CUSTOMER_WEALTH_BRACKET_HASHDIFF`, stage.`NAME`, stage.`DESCRIPTION`, stage.`LASTMODIFIEDDATE`, stage.`CREATEDDATE`, stage.`EFFECTIVE_FROM`, stage.`LOAD_DATE`, stage.`RECORD_SOURCE`
    FROM source_data AS stage
    LEFT JOIN latest_records
    ON latest_records.`CUSTOMER_WEALTH_BRACKET_HK` = stage.`CUSTOMER_WEALTH_BRACKET_HK`
        AND latest_records.`CUSTOMER_WEALTH_BRACKET_HASHDIFF` = stage.`CUSTOMER_WEALTH_BRACKET_HASHDIFF`
    WHERE latest_records.`CUSTOMER_WEALTH_BRACKET_HASHDIFF` IS NULL
)

SELECT * FROM records_to_insert
        ) as DBT_INTERNAL_SOURCE
        on FALSE

    

    when not matched then insert
        (`CUSTOMER_WEALTH_BRACKET_HK`, `CUSTOMER_WEALTH_BRACKET_HASHDIFF`, `NAME`, `DESCRIPTION`, `LASTMODIFIEDDATE`, `CREATEDDATE`, `EFFECTIVE_FROM`, `LOAD_DATE`, `RECORD_SOURCE`)
    values
        (`CUSTOMER_WEALTH_BRACKET_HK`, `CUSTOMER_WEALTH_BRACKET_HASHDIFF`, `NAME`, `DESCRIPTION`, `LASTMODIFIEDDATE`, `CREATEDDATE`, `EFFECTIVE_FROM`, `LOAD_DATE`, `RECORD_SOURCE`)


  