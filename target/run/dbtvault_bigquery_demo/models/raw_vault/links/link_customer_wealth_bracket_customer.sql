
        
    

    

    merge into `steadfast-task-363413`.`data_vault`.`link_customer_wealth_bracket_customer` as DBT_INTERNAL_DEST
        using (
          

    -- Generated by dbtvault.

    

WITH row_rank_1 AS (
    SELECT rr.`CUSTOMER_WEALTH_BRACKET_CUSTOMER_HK`, rr.`CUSTOMER_WEALTH_BRACKET_HK`, rr.`CUSTOMER_HK`, rr.`LOAD_DATE`, rr.`RECORD_SOURCE`,
        ROW_NUMBER() OVER(
               PARTITION BY rr.`CUSTOMER_WEALTH_BRACKET_CUSTOMER_HK`
               ORDER BY rr.`LOAD_DATE`
        ) AS row_number
    FROM `steadfast-task-363413`.`data_vault`.`v_stg_UK_customer` AS rr
    WHERE rr.`CUSTOMER_WEALTH_BRACKET_CUSTOMER_HK` IS NOT NULL
    AND rr.`CUSTOMER_WEALTH_BRACKET_HK` IS NOT NULL
    AND rr.`CUSTOMER_HK` IS NOT NULL
    QUALIFY row_number = 1
    ),


records_to_insert AS (
    SELECT a.`CUSTOMER_WEALTH_BRACKET_CUSTOMER_HK`, a.`CUSTOMER_WEALTH_BRACKET_HK`, a.`CUSTOMER_HK`, a.`LOAD_DATE`, a.`RECORD_SOURCE`
    FROM row_rank_1 AS a
    LEFT JOIN `steadfast-task-363413`.`data_vault`.`link_customer_wealth_bracket_customer` AS d
    ON a.`CUSTOMER_WEALTH_BRACKET_CUSTOMER_HK` = d.`CUSTOMER_WEALTH_BRACKET_CUSTOMER_HK`
    WHERE d.`CUSTOMER_WEALTH_BRACKET_CUSTOMER_HK` IS NULL
)

SELECT * FROM records_to_insert
        ) as DBT_INTERNAL_SOURCE
        on FALSE

    

    when not matched then insert
        (`CUSTOMER_WEALTH_BRACKET_CUSTOMER_HK`, `CUSTOMER_WEALTH_BRACKET_HK`, `CUSTOMER_HK`, `LOAD_DATE`, `RECORD_SOURCE`)
    values
        (`CUSTOMER_WEALTH_BRACKET_CUSTOMER_HK`, `CUSTOMER_WEALTH_BRACKET_HK`, `CUSTOMER_HK`, `LOAD_DATE`, `RECORD_SOURCE`)


  