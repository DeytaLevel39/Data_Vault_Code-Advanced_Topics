

  create or replace view `steadfast-task-363413`.`data_vault`.`v_stg_US_customer`
  OPTIONS()
  as 







WITH staging AS (
-- Generated by dbtvault.

    

WITH source_data AS (

    SELECT

    `CUSTOMER_ID`,
    `CUSTOMER_NUMBER`,
    `FIRST_NAME`,
    `LAST_NAME`,
    `LASTMODIFIEDDATE`,
    `CREATEDDATE`,
    `APPLIEDDATE`,
    `CRUD_FLAG`

    FROM `steadfast-task-363413`.`data_vault`.`v_raw_US_customer`
),

derived_columns AS (

    SELECT

    `CUSTOMER_ID`,
    `CUSTOMER_NUMBER`,
    `FIRST_NAME`,
    `LAST_NAME`,
    `LASTMODIFIEDDATE`,
    `CREATEDDATE`,
    `APPLIEDDATE`,
    `CRUD_FLAG`,
    CUSTOMER_NUMBER AS `US_CUSTOMER_KEY`,
    '101' AS `RECORD_SOURCE`,
    LASTMODIFIEDDATE AS `EFFECTIVE_FROM`

    FROM source_data
),

hashed_columns AS (

    SELECT

    `CUSTOMER_ID`,
    `CUSTOMER_NUMBER`,
    `FIRST_NAME`,
    `LAST_NAME`,
    `LASTMODIFIEDDATE`,
    `CREATEDDATE`,
    `APPLIEDDATE`,
    `CRUD_FLAG`,
    `US_CUSTOMER_KEY`,
    `RECORD_SOURCE`,
    `EFFECTIVE_FROM`,

    CAST(UPPER(TO_HEX(SHA256(NULLIF(UPPER(TRIM(CAST(`US_CUSTOMER_KEY` AS STRING))), '')))) AS STRING) AS `CUSTOMER_HK`,
    UPPER(TO_HEX(SHA256(CONCAT(
        IFNULL(NULLIF(UPPER(TRIM(CAST(`APPLIEDDATE` AS STRING))), ''), '^^'),'||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(`CREATEDDATE` AS STRING))), ''), '^^'),'||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(`CRUD_FLAG` AS STRING))), ''), '^^'),'||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(`CUSTOMER_ID` AS STRING))), ''), '^^'),'||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(`CUSTOMER_NUMBER` AS STRING))), ''), '^^'),'||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(`FIRST_NAME` AS STRING))), ''), '^^'),'||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(`LAST_NAME` AS STRING))), ''), '^^'),'||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(`LASTMODIFIEDDATE` AS STRING))), ''), '^^')
    )))) AS `CUSTOMER_HASHDIFF`

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    `CUSTOMER_ID`,
    `CUSTOMER_NUMBER`,
    `FIRST_NAME`,
    `LAST_NAME`,
    `LASTMODIFIEDDATE`,
    `CREATEDDATE`,
    `APPLIEDDATE`,
    `CRUD_FLAG`,
    `US_CUSTOMER_KEY`,
    `RECORD_SOURCE`,
    `EFFECTIVE_FROM`,
    `CUSTOMER_HK`,
    `CUSTOMER_HASHDIFF`

    FROM hashed_columns
)

SELECT * FROM columns_to_select
)

SELECT *,
       '2009-11-05 08.36.0000000' AS LOAD_DATE
FROM staging;

